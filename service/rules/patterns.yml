# patterns.yml — v4 coverage-first precision pack

###############################################################################
# A) ARRIVAL-DAY CUTOFFS (your cluster: “BEFORE 1200 DAY OF ARRIVAL”, etc.)
###############################################################################

- id: arrival_day_before_numeric_time
  priority: 96
  regex: '\b-?\s*(?:CANCELLATION\s+PERMITTED\s+)?(?:BEFORE|BY)\s+(?<hhmm>\d{3,4}|\d{1,2}:\d{2})\s+(?:DAY\s+OF\s+ARR(?:IVAL)?)\b'
  map:
    policy.cancellable: "true"
    window.type: arrival_day
    deadline.type: arrival_day_cutoff
    deadline.local_time: "$hhmm"

- id: arrival_day_before_noon
  priority: 96
  regex: '\b-?\s*(?:CANCELLATION\s+PERMITTED\s+)?(?:BEFORE|BY)\s+NOON\s+(?:DAY\s+OF\s+ARR(?:IVAL)?)\b'
  map:
    policy.cancellable: "true"
    window.type: arrival_day
    deadline.type: arrival_day_cutoff
    deadline.local_time: "1200"

- id: arrival_day_before_midnight
  priority: 96
  regex: '\b-?\s*(?:CANCELLATION\s+PERMITTED\s+)?(?:BEFORE|BY)\s+MIDNIGHT\s+(?:DAY\s+OF\s+ARR(?:IVAL)?)\b'
  map:
    policy.cancellable: "true"
    window.type: arrival_day
    deadline.type: arrival_day_cutoff
    deadline.local_time: "0000"

- id: arrival_day_by_6pm
  priority: 96
  regex: '\b-?\s*(?:CANCELLATION\s+PERMITTED\s+)?(?:BEFORE|BY)\s*6\s*PM\s+(?:LOCAL\s+(?:HOTEL\s+)?TIME\s+)?(?:DAY\s+OF\s+ARR(?:IVAL)?)\b'
  map:
    policy.cancellable: "true"
    window.type: arrival_day
    deadline.type: arrival_day_cutoff
    deadline.local_time: "1800"

- id: cxl_on_arr_date_clock
  priority: 95
  regex: '\b(?<clock>\d{1,2}\s*PM|\d{3,4})\s+CXL\s+ON\s+ARR\s+DATE\b'
  map:
    policy.cancellable: "true"
    window.type: arrival_day
    deadline.type: arrival_day_cutoff
    deadline.local_time: "$clock"

###############################################################################
# B) RELATIVE CUTOFFS (DAYS/HOURS PRIOR TO ARRIVAL)
###############################################################################

- id: cutoff_days_prior
  priority: 90
  regex: '\b(?<days>\d+)\s*DAYS?\s*(?:PRIOR|BEFORE)\s*(?:TO\s*)?(?:ARR(?:IVAL)?)\b'
  map:
    policy.cancellable: "true"
    window.type: relative_to_arrival
    window.cutoff_days: "$days"
    deadline.type: relative
    deadline.relation: to_arrival
    deadline.relative_days: "$days"

- id: cutoff_hours_prior
  priority: 90
  regex: '\b(?<hours>\d+)\s*H(?:RS?|OURS?)?\s*(?:PRIOR|BEFORE)\s*(?:TO\s*)?(?:ARR(?:IVAL)?)\b'
  map:
    policy.cancellable: "true"
    window.type: relative_to_arrival
    window.cutoff_days: "ceil($hours/24)"
    deadline.type: relative
    deadline.relation: to_arrival
    deadline.relative_hours: "$hours"

- id: cancel_by_local_time_relative_days
  priority: 88
  regex: '\bCANCEL(?:LED)?\s+BY\s+(?<hhmm>\d{1,2}(?::\d{2})?|(?:(?:0?\d|1[0-2]))\s*PM)\s+(?:LOCAL\s+(?:HOTEL\s+)?TIME)\s+(?<days>\d+)\s+DAYS?\s+PRIOR\s+TO\s+ARR(?:IVAL)?\b'
  map:
    policy.cancellable: "true"
    window.type: relative_to_arrival
    window.cutoff_days: "$days"
    deadline.type: relative_with_time
    deadline.relation: to_arrival
    deadline.relative_days: "$days"
    deadline.local_time: "$hhmm"

###############################################################################
# C) ABSOLUTE DEADLINES (Hotel local time on date; ISO “CANCEL BY …”)
###############################################################################

- id: htl_time_on_ddmonyy
  priority: 95
  regex: '\bCXL\s+(?<hhmm>\d{3,4})\s+HTL\s+TIME\s+ON\s+(?<dd>\d{2})(?<mon>JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)(?<yy>\d{2})\b'
  map:
    policy.cancellable: "true"
    deadline.type: absolute_hotel_time
    deadline.local_time: "$hhmm"
    deadline.date_ddmmmyy: "$dd$mon$yy"
    deadline.absolute_hotel_time: "1"   # flag for scorers, if any

- id: cancel_by_iso
  priority: 100
  regex: '\bCANCEL\s+BY\s+(?<iso>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})\b'
  map:
    policy.cancellable: "true"
    deadline.type: absolute_iso
    deadline.iso: "$iso"

###############################################################################
# D) FEES & PENALTIES (fixed amount, nights, percent, full stay)
###############################################################################

# “1058.00 CNY CXL FEE PER ROOM”
- id: fee_per_room_amount_currency
  priority: 92
  regex: '\b(?<amount>\d{1,3}(?:[.,]\d{3})*(?:[.,]\d+)?|\d+(?:[.,]\d+)?)\s*,?\s*(?<currency>[A-Z]{3})\s+CXL\s+FEE\s+PER\s+ROOM\b'
  map:
    fee.type: fixed_amount
    fee.amount: "$amount"
    fee.currency: "$currency"

# “PENALTY AMOUNT 17917.24”
- id: penalty_amount_value
  priority: 98
  regex: '\bPENALTY\s+AMOUNT\s+(?<amount>\d{1,3}(?:[.,]\d{3})*(?:[.,]\d+)?|\d+(?:[.,]\d+)?)\b'
  map:
    penalty.amount: "$amount"

# Nights penalties: “FEE 1 NIGHT”, “PENALTY OF 1 NIGHT”, “1 NT/1NT”
- id: fee_one_night_simple
  priority: 94
  regex: '\b(?:FEE|CHARGE|PENALTY)\s+1\s+(?:NITE|NIGHT)\b'
  map:
    fee.type: nights_penalty
    fee.nights: "1"

- id: penalty_of_one_night
  priority: 94
  regex: '\bPENALTY\s+OF\s+1\s+(?:NITE|NIGHT)\b'
  map:
    fee.type: nights_penalty
    fee.nights: "1"

- id: nights_generic
  priority: 86
  regex: '\b(?<n>\d+)\s*(?:NIGHTS?|NT|NITE)\b'
  map:
    fee.type: nights_penalty
    fee.nights: "$n"

# Percentage penalties: “100 PCT”, “100% (OF STAY)”
- id: percent_100
  priority: 92
  regex: '\b100\s*(?:%|PCT)(?:\s*(?:OF\s+STAY|\bSTAY\b))?\b'
  map:
    fee.type: percentage
    fee.percent: "100"

- id: percent_generic
  priority: 80
  regex: '\b(?<pct>\d{1,3})\s*(?:%|PCT)(?:\s*(?:OF\s+STAY|\bSTAY\b))?\b'
  map:
    fee.type: percentage
    fee.percent: "$pct"

# Full stay (explicit non-percentage wording)
- id: fee_full_stay
  priority: 92
  regex: '\b(?:CXL\s+FEE\s+)?FULL\s+STAY\b'
  map:
    fee.type: full_stay

# Tax scope
- id: incl_tax_fees
  priority: 70
  regex: '\bINCL\s+TAX-?FEES\b'
  map:
    fee.tax_scope: included

- id: excl_tax_fees
  priority: 70
  regex: '\bEXCL\s+TAX-?FEES\b'
  map:
    fee.tax_scope: excluded

###############################################################################
# E) CANCELLABLE / NON-CANCELLABLE FLAGS
###############################################################################

- id: cancellation_permitted_marker
  priority: 60
  regex: '\bCANCELLATION\s+PERMITTED\b'
  map:
    policy.cancellable: "true"

- id: nonrefundable_markers
  priority: 99
  regex: '\bNON-?REFUNDABLE|NON-?CANCELLABLE|NON-?AMENDABLE\b'
  map:
    policy.cancellable: "false"
    fee.type: non_refundable

- id: always_charged_markers
  priority: 99
  regex: '\bCANCELS\s+ALWAYS\s+CHARGED\b'
  map:
    policy.cancellable: "false"

###############################################################################
# F) CREDIT CARD / DEPOSIT / GUARANTEE
###############################################################################

- id: credit_card_required
  priority: 60
  regex: '\b(?:CREDIT\s+CARD|CC)\s+(?:REQ|REQUIRED|GUARANTEE(?:D)?)\b'
  map:
    policy.flags.credit_card_guarantee: "true"

- id: deposit_at_booking
  priority: 60
  regex: '\b(?<n>\d+\s*(?:NT|NIGHTS?)|100\s*%|100PCT)\s+DPST(?:\s+AT\s+BOOKING)?\b'
  map:
    policy.flags.deposit_required: "true"
    policy.flags.deposit_note: "$n"

###############################################################################
# G) FREE CANCELLATION WINDOWS (positive phrasing)
###############################################################################

- id: free_cancellation_until_arrival_day_time
  priority: 76
  regex: '\bFREE\s+CANCELLATION\s+(?:UNTIL|TILL)\s+(?<hhmm>\d{3,4}|\d{1,2}:\d{2}|NOON|MIDNIGHT)\s+(?:DAY\s+OF\s+ARR(?:IVAL)?)\b'
  map:
    policy.cancellable: "true"
    free_cancel.type: arrival_day
    free_cancel.local_time: "$hhmm"

- id: free_cancellation_up_to_days_prior
  priority: 76
  regex: '\bCANCELLATION\s+PERMITTED\s+UP\s*TO\s+(?<d>\d+)\s*DAYS?\s+BEFORE\s+ARR(?:IVAL)?\b'
  map:
    policy.cancellable: "true"
    free_cancel.type: relative_to_arrival
    free_cancel.cutoff_days: "$d"

- id: free_cancellation_after_booking_days
  priority: 76
  regex: '\bCANCELLATION\s+PERMITTED\s+UP\s*TO\s+(?<d>\d+)\s*DAYS?\s+AFTER\s+BOOKING\b'
  map:
    policy.cancellable: "true"
    free_cancel.type: relative_to_booking
    free_cancel.cutoff_days: "$d"

###############################################################################
# H) TIERED PENALTY SCHEDULES (common in your set)
###############################################################################

# e.g., "TWO DAYS PRIOR TO ARRIVAL: 10"  (we capture the percentage)
- id: tier_two_days_prior
  priority: 72
  regex: '\bTWO\s+DAYS?\s+PRIOR\s+TO\s+ARR(?:IVAL)?:\s*(?<pct>\d{1,3})\b'
  map:
    tiers.two_days_prior.percent: "$pct"

# "ONE DAY PRIOR TO ARRIVAL: 20"
- id: tier_one_day_prior
  priority: 72
  regex: '\bONE\s+DAY\s+PRIOR\s+TO\s+ARR(?:IVAL)?:\s*(?<pct>\d{1,3})\b'
  map:
    tiers.one_day_prior.percent: "$pct"

# "ON THE DAY OF ARRIVAL: 80"
- id: tier_day_of_arrival
  priority: 72
  regex: '\bON\s+THE,\s*DAY\s+OF\s+ARR(?:IVAL)?:\s*(?<pct>\d{1,3})\b'
  map:
    tiers.day_of_arrival.percent: "$pct"

# "NO SHOW: 100"
- id: tier_no_show
  priority: 72
  regex: '\bNO\s+SHOW:\s*(?<pct>\d{1,3})\b'
  map:
    tiers.no_show.percent: "$pct"

- id: fee_per_room_amount_currency
  priority: 92
  regex: '\b(?<amount>\d{1,3}(?:[.,]\d{3})*(?:[.,]\d+)?|\d+(?:[.,]\d+)?)\s*,?\s*(?<currency>[A-Z]{3})\s+CXL\s+FEE\s+PER\s+ROOM\b'
  map:
    fee.type: fixed_amount
    fee.amount: "$amount"
    fee.currency: "$currency"
    fee.per_room: "true"
